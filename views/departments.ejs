<%- include('partials/layout', { title: 'Department List' }) %>

<div class="container mt-5">
  <div class="d-flex mb-2 justify-content-between">
    <h3>Departments</h3>

    <!-- Modal -->
    <div>
      <!-- Button trigger modal -->
      <button
        type="button"
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#exampleModal"
      >
        Add new Department
      </button>

      <!-- Modal -->
      <div
        class="modal fade"
        id="exampleModal"
        tabindex="-1"
        aria-labelledby="exampleModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">
                Add new Department
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <form id="departmentForm">
                <div class="mb-3">
                  <label for="departmentName" class="form-label">Name</label>
                  <input
                    type="text"
                    class="form-control"
                    id="departmentName"
                    required
                    placeholder="Insert Department name"
                  />
                </div>

                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    Close
                  </button>
                  <button
                    type="button"
                    class="btn btn-primary"
                    onclick="addDepartment('${dept._id}')"
                  >
                    Submit
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th>Name</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="departmentTable">
      <!-- Department rows will be dynamically populated here -->
    </tbody>
  </table>

  <footer class="bg-light text-center py-3 mt-5">
    <p>&copy; 2025 Apollonia Dental Practice</p>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>

<script
  src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
  integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
  crossorigin="anonymous"
></script>
<script
  src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
  integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
  crossorigin="anonymous"
></script>
<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
  integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
  crossorigin="anonymous"
></script>

<script>
  // Employee fetching and actions
  document.addEventListener("DOMContentLoaded", function () {
    fetchDepartments();
  });

  function fetchDepartments() {
    fetch("/api/departments")
      .then((response) => response.json())
      .then((data) => {
        console.log("departments:", data);
        const table = document.getElementById("departmentTable");
        table.innerHTML = "";
        data.forEach((dept) => {
          const row = `
          <tr>
            <td>${dept.name}</td>
            <td>
              <button class="btn btn-warning" onclick="editEmployee('${dept._id}')">Edit</button>
              <button class="btn btn-danger" onclick="deleteEmployee('${dept._id}')">Delete</button>
            </td>
          </tr>
        `;
          table.innerHTML += row;
        });
      })
      .catch((err) => console.error("Error fetching departments:", err));
  }

  function editDept(id) {
    fetch(`/api/departments/${id}`, { method: "PUT" })
      .then((response) => response.json())
      .then((data) => {
        document.getElementById("departmentName").value = data.name;
        document.getElementById("employeeDepartment").value =
          data.department._id;
        document.getElementById("employeeForm").dataset.id = data._id;
      })
      .catch((err) => console.error("Error editing employee:", err));
  }

  function deleteDepartment(id) {
    fetch(`/api/departments/${id}`, { method: "DELETE" })
      .then(() => {
        fetchDepartments();
      })
      .catch((err) => console.error("Error deleting employee:", err));
  }

  function addDepartment(id) {
    const name = document.getElementById("newDepartmentName").value;
    const data = { name };
    fetch("/api/departments", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(data),
    })
      .then((response) => response.json())
      .then(() => {
        fetchDepartments();
      })
      .catch((err) => console.error("Error:", err));
  }
</script>
